# shutdownå’Œcloseçš„ä½œç”¨éƒ½æ˜¯å…³é—­ä¸€ä¸ªTCPè¿žæŽ¥ã€‚ç®€å•æ¥è¯´,ä¸¤è€…çš„ä¸åŒåœ°æ–¹æœ‰:
*  è°ƒç”¨`socket.shutdown()`çš„è¯ä¼šèµ°TCPæ–­å¼€å››æ¬¡æ¡æ‰‹æµç¨‹,å³æ˜¯ä¸»åŠ¨æ–­å¼€æ–¹ä¼šå‘é€ä¸€ä¸ªFINæ¶ˆæ¯
*  è°ƒç”¨`socket.close()`çš„è¯ä¼šä¸»åŠ¨æ–­å¼€æ–¹ä¼šå‘é€ä¸€ä¸ª`RST`å¤ä½æ¶ˆæ¯ï¼Œç„¶åŽé©¬ä¸Šæ–­å¼€æŠ›å¼ƒè¿™ä¸ªsocket,æ­¤æ—¶æœåŠ¡æ–¹å¯èƒ½ä¼šæŠ›å‡ºä¸€ä¸ª`è¿œç¨‹å®¢æˆ·ç«¯å·²ç»å…³ç³»`çš„å¼‚å¸¸.  
* shutdown()ç”¨æ¥å…³é—­è¿žæŽ¥,è€Œä¸æ˜¯å¥—æŽ¥å­—,ä¸ç®¡è°ƒç”¨å¤šå°‘æ¬¡shutdown(),å¥—æŽ¥å­—ä¾ç„¶å­˜åœ¨,ç›´åˆ°è°ƒç”¨ close()å°†å¥—æŽ¥å­—ä»Žå†…å­˜æ¸…é™¤ã€‚

### socket.shutdown(å‚æ•°ç±»åž‹)       
* SHUT_RDï¼šæ–­å¼€è¾“å…¥æµã€‚å¥—æŽ¥å­—æ— æ³•æŽ¥æ”¶æ•°æ®ï¼ˆå³ä½¿è¾“å…¥ç¼“å†²åŒºæ”¶åˆ°æ•°æ®ä¹Ÿè¢«æŠ¹åŽ»ï¼‰ï¼Œæ— æ³•è°ƒç”¨è¾“å…¥ç›¸å…³å‡½æ•°ã€‚
* SHUT_WRï¼šæ–­å¼€è¾“å‡ºæµã€‚å¥—æŽ¥å­—æ— æ³•å‘é€æ•°æ®ï¼Œä½†å¦‚æžœè¾“å‡ºç¼“å†²åŒºä¸­è¿˜æœ‰æœªä¼ è¾“çš„æ•°æ®ï¼Œåˆ™å°†ä¼ é€’åˆ°ç›®æ ‡ä¸»æœºã€‚
* SHUT_RDWRï¼šåŒæ—¶æ–­å¼€ I/O æµã€‚ç›¸å½“äºŽåˆ†ä¸¤æ¬¡è°ƒç”¨ shutdown()ï¼Œå…¶ä¸­ä¸€æ¬¡ä»¥ SHUT_RD ä¸ºå‚æ•°ï¼Œå¦ä¸€æ¬¡ä»¥ SHUT_WR ä¸ºå‚æ•°ã€‚

### pythonè‡ªå¸¦çš„http.client         

pythonè‡ªå¸¦çš„http.client,å®˜æ–¹å…³é—­çš„æ–¹å¼ä¸ºç›´æŽ¥è°ƒç”¨çš„`conn.close()`.çœ‹æºç ,å³ä¸ºç›´æŽ¥è°ƒç”¨çš„socket.close()    
```python

conn = http.client.HTTPConnection("127.0.0.1",9999)
url = "/"
conn.putrequest('PUT', url)
conn.putheader('Transfer-Encoding', 'chunked')
conn.endheaders()
conn.send(chunk_data(body, size_per_chunk).encode('utf-8'))
resp = conn.getresponse()
conn.close()

### HTTPConnection.close()æºç :
def close(self):
    """Close the connection to the HTTP server."""
    self.__state = _CS_IDLE
    try:
        sock = self.sock
        if sock:
            self.sock = None
            sock.close()   # è¿™é‡Œç›´æŽ¥è°ƒç”¨çš„socket.close(),ç›´æŽ¥å…³é—­åŒæ–¹çš„socket,è€Œä¸ç»è¿‡æ¡æ‰‹é˜¶æ®µ
    finally:
        response = self.__response
        if response:
            self.__response = None
            response.close()

```

### socket.close()å‘é€äº†é‚£äº›æ•°æ®?   
æˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„HTTPæœåŠ¡,ç”¨`http.client`å‘é€ä¸€ä¸ªç®€å•çš„è¯·æ±‚åŽç›´æŽ¥è°ƒç”¨`close`æ–¹æ³•,ç”¨æŠ“åŒ…å·¥å…·çœ‹ä¸‹æ•´ä¸ªæµç¨‹å‘é€äº†é‚£äº›çŠ¶æ€åŒ….
![http.client](../recource/images/TCP-SHUTDOWN-RST.png)     
ä»ŽæŠ“åˆ°çš„æ•°æ®åŒ…æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æžœåªæ˜¯ç®€å•çš„è°ƒç”¨äº†`close`,socketä¼šç›´æŽ¥å‘é€ä¸€ä¸ª`RST`æ¶ˆæ¯å¹¶é©¬ä¸Šå…³é—­socket,è€Œä¸ä¼šå‘é€`FIN`èµ°4æ¬¡æ¡æ‰‹åŽ»æ–­å¼€è¿žæŽ¥ã€‚        
è¢«åŠ¨å…³é—­æ–¹æ”¶åˆ°`RST`åŽï¼Œç”±äºŽæ­¤æ—¶ä¸»åŠ¨å…³é—­æ–¹å·²ç»å…³é—­äº†socketè¿žæŽ¥ï¼Œå›ºæ­¤æ—¶ä¼šæŠ›å‡ºä¸€ä¸ª`è¿œç¨‹æœåŠ¡å·²ç»å…³é—­çš„å¼‚å¸¸`     
![close](../recource/images/TCP-SHUTDOWN-RST-SERVER-ERROR.png)      


### socket.shutdown()å‘é€äº†é‚£äº›æ•°æ®ï¼Ÿ
æˆ‘ä»¬æŽ¥ä¸‹æ¥å†æŠŠ`http.client`çš„`close`æ³¨é‡ŠæŽ‰ï¼Œæ¢æˆ`socket.shutdown`,å¹¶ä¸”ä¼ å…¥ä¸åŒçš„SHUTDOWNå‚æ•°,åŒæ ·ç”¨æŠ“åŒ…å·¥å…·åˆ†æžä¸‹æ•´ä¸ªè¿‡ç¨‹.

- socket.shutdown(socket.SHUT_WR)       
![SHUT_WR](../recource/images/TCP-SHUTDOWN-FIN-SHUT-WR.png)

- socket.shutdown(socket.SHUT_RD)  
![SHUT_RD](../recource/images/TCP-SHUTDOWN-FIN-SHUT-RD.png)     

- socket.shutdown(socket.SHUT_RDWR)
![SHUT_RD](../recource/images/TCP-SHUTDOWN-FIN-SHUT-WRRD.png) 


- é€šè¿‡å¯¹ä¸åŒå‚æ•°çš„æŠ“åŒ…åˆ†æžå¯å¾—.è°ƒç”¨`socket.shutdown`çš„æ—¶å€™.å¦‚æžœä¼ é€’çš„ä¸ºSHUT_WR.æ­¤æ—¶socketä¼šèµ°æ­£å¸¸çš„å››æ¬¡æ–­å¼€æ¡æ‰‹æµç¨‹(finæ¶ˆæ¯).å¦‚æžœä¸ºå…¶ä»–,åˆ™è¿˜æ˜¯è·Ÿç›´æŽ¥è°ƒç”¨çš„`socket.close`ä¸€æ ·.ç›´æŽ¥å‘é€çš„`RST`å¤ä½æ¶ˆæ¯æŠ›å¼ƒè¯¥socketè¿žæŽ¥.


### backlogå‚æ•°
å½“æˆ‘ä»¬ç¼–å†™socketç»‘å®šç›‘å¬ç«¯å£çš„æ—¶å€™,è°ƒç”¨äº†ç³»ç»Ÿæä¾›socket.listen(),è¿™ä¸ªå‡½æ•°æœ‰ä¸ªbacklog,å¯ä»¥ç”¨æ¥é™å®štcpæ¡æ‰‹è¿‡ç¨‹ä¸­**åŠé“¾æŽ¥é˜Ÿåˆ—**å’Œ**å…¨è¿žæŽ¥**é˜Ÿåˆ—çš„é•¿åº¦.

#### åŠè¿žæŽ¥å’Œå…¨è¿žæŽ¥
æ¯ä¸ªTCPçš„é“¾æŽ¥é˜Ÿåˆ—éƒ½ä¼šè¿›è¡Œ3æ¬¡æ¡æ‰‹,å½“å®¢æˆ·ç«¯å‘èµ·ç¬¬ä¸€æ¡æ‰‹è¯·æ±‚ACKåˆ°æœåŠ¡ç«¯,æœåŠ¡ç«¯æ”¶åˆ°åŽå‘é€ACK+SYNåˆ°å®¢æˆ·ç«¯,æ­¤æ—¶æœåŠ¡ç«¯ä¼šæŠŠè¯¥é“¾æŽ¥æ·»åŠ åˆ°åŠé“¾æŽ¥é˜Ÿåˆ—ï¼ˆSYN_REVDçŠ¶æ€ï¼‰.å½“å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„ACK+SYNæ¶ˆæ¯åŽï¼Œå›žå¤ackç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°åŽï¼ŒæŠŠsocketä»ŽåŠè¿žæŽ¥é˜Ÿåˆ—ä¸­å–å‡ºï¼Œæ·»åŠ åˆ°å®Œå…¨é“¾æŽ¥é˜Ÿåˆ—ä¸­(ESTABLISHEDçŠ¶æ€)ï¼Œç­‰åˆ°æœåŠ¡ç«¯è°ƒç”¨accept(),åŽ,å†æŠŠsocketä»Žå®Œå…¨é˜Ÿåˆ—ä¸­å–å‡º,é“¾æŽ¥å»ºç«‹ã€‚

![](backlog.png)

å½“åŠè¿žæŽ¥é˜Ÿåˆ—æ»¡äº†ä¹‹åŽ,æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚é“¾æŽ¥ä¼šæŠ›å‡º**ConnectionRefusedError: [WinError 10061] ç”±äºŽç›®æ ‡è®¡ç®—æœºç§¯æžæ‹’ç»ï¼Œæ— æ³•è¿žæŽ¥ã€‚**çš„é”™è¯¯ã€‚æœ‰æŠ“åŒ…å·¥å…·å¯çŸ¥,å½“é“¾æŽ¥é˜Ÿåˆ—æ»¡äº†ä¹‹åŽï¼Œå†å‘é€synè¯·æ±‚,ä¼šå—åˆ° ack+rst çš„å“åº”.ðŸ‘‡:

![](backlogrefuse.png)


## æ€»ç»“
ä½†ç”¨å®¢æˆ·ç«¯åšHTTPè¯·æ±‚ï¼Œå¦‚æžœè‡ªå·±æ‰‹åŠ¨å…³é—­ï¼Œåˆ™æ­£ç¡®çš„æ–¹å¼åº”è¯¥ä¸º: `socket.shutdown(socket.SHUT_WR) --> socket.close()`        
![NORMAL](../recource/images/TCP-SHUTDOWN-FIN-NORMAL.png)




